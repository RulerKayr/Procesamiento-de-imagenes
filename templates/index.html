<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editor de Imágenes Avanzado</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container">
    <h1>Editor de Imágenes Avanzado</h1>

    <!-- Subir imagen -->
    <section class="section">
        <label for="imageUpload">📤 Subir imagen:</label>
        <input type="file" id="imageUpload" accept="image/*"><br>
        <div class="image-compare">
            <div>
                <h3>🖼 Imagen original</h3>
                <img id="preview" alt="Previsualización original" />
            </div>
            <div>
                <h3>🧪 Imagen procesada</h3>
                <img id="processedImage" alt="Imagen procesada" />
            </div>
        </div>
    </section>

    <!-- Filtros manuales -->
    <section class="section">
        <h2>🛠 Ajustes Manuales</h2>
        <select id="manualEffect">
            <option value="none">Sin efecto</option>
            <option value="grayscale">Escala de grises</option>
            <option value="invert">Invertido</option>
            <option value="brightness">Brillo</option>
            <option value="blur">Desenfoque</option>
            <option value="canny">Detección de bordes (Canny)</option>
            <option value="sepia">Sepia</option>
            <option value="cartoon">Cartoon</option>
        </select>

        <div id="brightness-control" class="control-group hidden">
            <label for="brightness">Brillo:</label>
            <input type="range" id="brightness" min="-100" max="100" value="0">
        </div>

        <div id="blur-control" class="control-group hidden">
            <label for="blur">Desenfoque:</label>
            <input type="range" id="blur" min="1" max="51" step="2" value="15">
        </div>
    </section>

    <!-- Herramientas inteligentes -->
    <section class="section">
        <h2>🧠 Herramientas Inteligentes</h2>
        <label><input type="checkbox" id="faceBlur"> Desenfoque de rostros</label><br>
        <label><input type="checkbox" id="ocr"> Extraer texto (OCR)</label><br>
        <label><input type="checkbox" id="contours"> Detectar contornos</label>
    </section>

    <!-- Utilidades -->
    <section class="section">
        <h2>🖋 Utilidades</h2>
        <label for="watermark">Marca de agua (texto):</label>
        <input type="text" id="watermark" placeholder="Ej. MiMarca"><br>
        <label><input type="checkbox" id="compress"> Comprimir imagen</label>
    </section>

    <!-- Controles -->
    <section class="section">
        <h2>⚙️ Procesar</h2>
        <label for="format">Formato de salida:</label>
        <select id="format">
            <option value="jpg">JPG</option>
            <option value="png">PNG</option>
            <option value="svg">SVG</option>
        </select>

        <button id="processImage">Procesar Imagen</button>
        <button id="resetImage">Restablecer Imagen</button>
        <button id="toggleDark">Modo Oscuro</button>
    </section>

    <!-- Descarga y texto OCR -->
    <section class="section">
        <a id="downloadBtn" style="display:none;" download="imagen_procesada.jpg" class="download-button">Descargar imagen</a>
        <h2>📄 Texto extraído</h2>
        <pre id="ocrText" style="white-space: pre-wrap;"></pre>
    </section>
</div>

<script>
const fileInput = document.getElementById('imageUpload');
const preview = document.getElementById('preview');
const processedImage = document.getElementById('processedImage');
const downloadBtn = document.getElementById('downloadBtn');
const brightnessControl = document.getElementById('brightness-control');
const blurControl = document.getElementById('blur-control');
const manualEffect = document.getElementById('manualEffect');
const ocrText = document.getElementById('ocrText');
let originalImageFile = null;

fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (file) {
        originalImageFile = file;
        preview.src = URL.createObjectURL(file);
    }
});

manualEffect.addEventListener('change', () => {
    brightnessControl.classList.toggle('hidden', manualEffect.value !== 'brightness');
    blurControl.classList.toggle('hidden', manualEffect.value !== 'blur');
});

document.getElementById('processImage').addEventListener('click', () => {
    const formData = new FormData();
    const selectedFile = originalImageFile;
    if (!selectedFile) return;

    formData.append('image', selectedFile);
    formData.append('manualEffect', document.getElementById('manualEffect').value);
    formData.append('format', document.getElementById('format').value);
    formData.append('brightness', document.getElementById('brightness').value);
    formData.append('blur', document.getElementById('blur').value);
    formData.append('watermark', document.getElementById('watermark').value);
    formData.append('compress', document.getElementById('compress').checked);
    formData.append('ocr', document.getElementById('ocr').checked);
    formData.append('faceBlur', document.getElementById('faceBlur').checked);
    formData.append('contours', document.getElementById('contours').checked);

    fetch('/upload', { method: 'POST', body: formData })
        .then(res => {
            const contentType = res.headers.get("Content-Type");
            if (contentType && contentType.includes("text/plain")) {
                return res.text().then(text => {
                    ocrText.textContent = text;
                    processedImage.style.display = 'none';
                    downloadBtn.style.display = 'none';
                });
            } else {
                return res.blob().then(blob => {
                    const url = URL.createObjectURL(blob);
                    processedImage.src = url;
                    processedImage.style.display = 'block';
                    downloadBtn.href = url;
                    const format = document.getElementById('format').value;
                    downloadBtn.download = `imagen_procesada.${format}`;
                    downloadBtn.style.display = 'inline-block';
                    ocrText.textContent = '';
                });
            }
        });
});

document.getElementById('resetImage').addEventListener('click', () => {
    if (originalImageFile) preview.src = URL.createObjectURL(originalImageFile);
    processedImage.src = '';
    downloadBtn.style.display = 'none';
    ocrText.textContent = '';
});

document.getElementById('toggleDark').addEventListener('click', () => {
    document.body.classList.toggle('dark');
});
</script>
</body>
</html>
